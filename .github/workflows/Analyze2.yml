name: Security Analysis (CodeQL + TruffleHog)
on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  security_scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python,go

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Install TruffleHog (binary release)
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/trufflesecurity/trufflehog/releases/latest | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url')
          curl -L "$LATEST_URL" -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          sudo mv trufflehog /usr/local/bin/trufflehog
          trufflehog --version

      - name: Debug: listar repo y mostrar preview de secrets.txt
        run: |
          echo "PWD: $(pwd)"
          ls -la
          echo "=== HEAD secrets.txt ==="
          head -n 50 secrets.txt || echo "‚ùå No existe secrets.txt"

      - name: Run TruffleHog (modo git, producir JSONL)
        id: run_trufflehog
        run: |
          set -o pipefail
          OUT_JSONL=trufflehog-raw.jsonl
          OUT_JSON=trufflehog-results.json
          OUT_PRETTY=trufflehog-results.txt

          echo "üîç Escaneando el repo con TruffleHog..."
          trufflehog git file://$(pwd) --only-verified=false --json > "$OUT_JSONL" || true

          echo "Archivo raw (JSONL) size:"
          wc -c "$OUT_JSONL" || true
          echo "Primeros 500 bytes del raw (si existen):"
          head -c 500 "$OUT_JSONL" || true

          # Si el raw est√° vac√≠o, crear un JSONL vac√≠o (no obligatorio)
          if [ ! -s "$OUT_JSONL" ]; then
            echo "{}" > "$OUT_JSONL"
          fi

          # Converte JSONL (varias l√≠neas JSON) a un JSON array (compatibilidad)
          # jq -s lee m√∫ltiples objetos y los convierte en un array
          jq -s '.' "$OUT_JSONL" > "$OUT_JSON" || echo "[]">"$OUT_JSON"

          # Crea una versi√≥n legible mostrando path, detector y raw
          jq -r '.[] | "PATH: \(.path)\nDETECTOR: \(.DetectorName // .detector_name // \"-\")\nRAW: \(.Raw // .raw // \"-\")\n---"' "$OUT_JSON" > "$OUT_PRETTY" || echo "No hay hallazgos" > "$OUT_PRETTY"

          # Contar elementos reales (array length)
          RESULTS_COUNT=$(jq 'length' "$OUT_JSON" 2>/dev/null || echo 0)
          echo "results_count=$RESULTS_COUNT" >> $GITHUB_ENV

          # Mostrar resumen en logs
          if [ "$RESULTS_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Se encontraron $RESULTS_COUNT posibles secretos:"
            jq -c '.[]' "$OUT_JSON"
            # fallar el job si quiero (descomentar)
            # echo "Failing job because secrets were found" && exit 1
          else
            echo "‚úÖ No se encontraron secretos."
          fi

      - name: Upload TruffleHog raw + aggregated + pretty results
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: |
            trufflehog-raw.jsonl
            trufflehog-results.json
            trufflehog-results.txt
